{extend name="public/base" /}
{block name="css"}
{include file="public/bootstrap" /}
<style type="text/css">
    #phone-numbers span:active {
        background-color: blue;
    }
</style>
{/block}
{block name="body"}
<div class="layuimini-container">
    <div class="layuimini-main">
        <div class="container-fluid">
            <!--<div class="row  fs-4 text-danger my-5 justify-content-center">
                呼叫中心
            </div>-->
            <div class="row mt-5 justify-content-center">
                <div class="col-sm-12 col-lg-10 col-xl-7">
                    <div class="row justify-content-center mb-5">
                        <div class="col-md-8 col-sm-12 col-lg-6">
                            <div class="callout callout-info mt-0">
                                <h4>温馨提示</h4>
                                <div class="row">
                                    <div class="col py-3">
                                        <ol class="list-group list-group-numbered">
                                            <li class="list-group-item border-0">只允许拨打本公司业务电话，不允许拨打其他行业电话。</li>
                                            <li class="list-group-item border-0">拨号当中不允许出现：金融、地产相关高频行业。</li>
                                            <li class="list-group-item border-0">通话中不允许出现：代开发票、造假等违法字眼。</li>
                                            <li class="list-group-item border-0">不允许在通话中辱骂。</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8 col-sm-12 col-lg-6 ">
                            <div class="row pb-3" style="background-color: #f4f4f4;">
                                <div class="col">
                                    <div class="row ">
                                        <div class="col p-0">
                                            <input type="text" name="phone" value=""
                                                   placeholder="请输入号码"
                                                   class="w-100 callinginput fs-1 border-0 text-center py-5 bg-transparent" id="input"
                                                   onkeyup="this.value= this.value.match(/\d+(\d{0,2})?/) ? this.value.match(/\d+(\d{0,2})?/)[0] : ''">
                                        </div>
                                    </div>

                                    <!-- 拨号键 -->
                                    <div class="row row-cols-3 gy-5 py-4 justify-content-center fs-1" id="phone-numbers"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{/block}
{block name="js"}

<script>
    layui.use(['layer', 'miniTab'], function () {
        let $ = layui.jquery,
            layer = layui.layer,
            miniTab = layui.miniTab;

        miniTab.listen();

        // cookie
        let cookie = function (key = null, val = null, obj = {}) {
            if (key === null) {
                let val = [];
                let cookie = document.cookie.split('; ');
                $.each(cookie, function (index, item) {
                    let i = item.split('=');
                    val[i[0]] = i[1];
                })

                return val;
            } else {
                if (val === null) {
                    let val = '';
                    let cookie = document.cookie.split('; ');
                    $.each(cookie, function (index, item) {
                        let i = item.split('=');
                        if (i[0] === key) {
                            val = i[1];
                            return;
                        }
                    })

                    return val;
                } else {
                    document.cookie = key + '=' + val;
                    return true;
                }
            }
        }


        // 输入框获取焦点
        let inputFocus = function () {
            $("#input").focus();
        };
        inputFocus();

        let callinginput = $('.callinginput');
        // 生成拨号按键
        let btnSize = 4;    // 按键大小 单位：1rem = 16px
        let buildPhoneNumber = function () {
              let phoneNumbersDiv = $('#phone-numbers');
              let isPhoneIcon = false;
              let cssClass = 'align-middle cursor rounded-circle  d-inline-block';
              let css = {width: btnSize + 'rem', height: btnSize + 'rem', 'line-height': btnSize + 'rem', cursor: 'pointer', backgroundColor: "rgb(228, 228, 228)"};
              for (let i = 1; i < 14; i++) {
                  let col = $('<div />', {
                      class: 'col text-center'
                  });
                  let text = i;

                  // * 键
                  if (i === 10) {
                      text = `<i class="fa fa-asterisk"></i>`
                      col.append($('<span />', {
                          class: cssClass + ' fs-4'
                      }).css(css).html(text));
                  }

                  if (i === 11) {
                      text = 0;
                  }

                  // 删除键
                  if (i === 12) {
                      text = `<i class="fa fa-backspace text-sm-center small"></i>`;
                      col.append($('<span />', {
                          class: cssClass + ' fs-3'
                      }).css(css).html(text).on('click', function (e) {
                          callinginput.val('');
                          inputFocus();
                      }));
                  }

                  // 拨号键
                  if (i === 13) {
                      isPhoneIcon = true;
                      text = `<i class="fa fa-phone"></i>`;
                      css.backgroundColor = 'rgb(8, 86, 246)';
                      css.color = '#fff';
                      col.append($('<span />', {
                          class: cssClass + ' fs-2'
                      }).css(css).html(text).on('click', function (e) {
                          makeCall();
                      }));
                  } else {
                      isPhoneIcon = false;
                  }

                  if (Number.isFinite(text)) {
                      col.append($('<span />', {
                          class: cssClass,
                          'data-value': text
                      }).css(css).html(text).on('click', function (e) {
                          if (callinginput.val().length < 11) {
                              callinginput.val(callinginput.val() + $(this).data('value'));//输入框值,val()里面
                          }
                      }));
                  }

                  phoneNumbersDiv.append(col);
              }
        };
        buildPhoneNumber();

        callinginput.on('keydown', function (e) {
            // e.preventDefault();
            // 大键盘||小键盘
            if ((e.keyCode >= 48 && e.keyCode <= 57) || (e.keyCode >= 96 && e.keyCode <= 106)) {
                if (callinginput.val().length >= 11) {
                    return false
                }
            } else if (e.keyCode === 13) {
                makeCall();
            }
        })

        // 按键盘
        /*$(window).on('keydown', function (e) {
            // 大键盘||小键盘
            if ((e.keyCode >= 48 && e.keyCode <= 57) || (e.keyCode >= 96 && e.keyCode <= 106)) {
                if (callinginput.val().length < 11) {
                    callinginput.val(callinginput.val() + e.key);
                    // callinginput.val() + e.key;
                    console.log('lpp');
                    console.log(callinginput.val() + e.key);
                }

            } else if (e.keyCode === 13) {
                makeCall();
            }
        });*/

        //验证输入的是数字
        function isPhoneNo(phone) {
            let pattern = /^1[345789]\d{9}$/;
            return pattern.test(phone);
        }

        let makeCall = function () {
            let number = callinginput.val();

            if (number.length < 11 || !isPhoneNo(number)) {
                layer.msg('请输入正确的号码', {icon: 2});
                return false;
            }

            $.post('{:url("/hbcall/makeCall")}', {mobile: number}, function (res) {
                if (res.code === 1000) {
                    let con = `
                            <div style="padding: 50px; line-height: 30px; font-weight: 300;">
                                <p>请在<span class="fs-3 clock px-2">10</span>秒内用手机拨打号码：<h3>${res.data.xNumber}</h3> 进行通话。</p>
                            </div>
                        `;
                    layer.config({
                        extend: 'skin/blue.css',
                    }).open({
                        type: 1,
                        title: '拨号成功！',
                        closeBtn: 2,
                        area: '400px;',
                        shade: 0.8,
                        id: 'LAY_layuipro',
                        btnAlign: 'c',
                        moveType: 1,
                        skin: 'layer-ext-blue',
                        content: con,
                        success: function (layero, index) {
                            // 10秒倒计时
                            let t = 10;
                            let time = document.getElementsByClassName("clock")[0];
                            let getTime = function () {
                                t--;
                                time.innerHTML = t;
                                if (t < 0) {
                                    clearInterval(inter);
                                    // 关闭当前窗
                                    layer.close(index);
                                }
                            };

                            let inter = setInterval(getTime, 1000);
                        }
                    });
                } else {
                    let con = `
                        <div style="padding: 50px; line-height: 30px; font-weight: 300;">
                            <p>${res.msg}</p>
                        </div>
                    `;
                    layer.config({
                        extend: 'skin/red.css',
                    }).open({
                        title: res.info ?? '温馨提示',
                        type: 1,
                        area: '400px',
                        shade: 0.8,
                        id: 'LAY_layuipro',
                        btnAlign: 'c',
                        closeBtn: 2,
                        moveType: 1,
                        skin: 'layer-ext-red',
                        content: con
                    })
                }
            });

        }
    });
</script>

{/block}
