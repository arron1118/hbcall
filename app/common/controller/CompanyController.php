<?php


namespace app\common\controller;

use app\company\model\Company;
use think\facade\Session;
use think\facade\View;

class CompanyController extends \app\BaseController
{
    protected $middleware = [\app\company\middleware\Check::class];

    protected $view = null;

    protected $model = null;

    protected $userInfo = null;

    protected $returnData = [
        'code' => 0,
        'msg' => '未知错误',
        'data' => []
    ];

    protected function initialize()
    {
        parent::initialize(); // TODO: Change the autogenerated stub

        $this->view = View::instance();
//        $this->view->engine()->layout('layout');
        $this->userInfo = Company::withCount('user')->findOrEmpty(Session::get('company.id'));

        if (!$this->userInfo->isEmpty() && !$this->userInfo->getData('status') && ($this->request->action() !== 'logout')) {
            showAlert(lang('Account is locked'), [
                'end' => 'function () {
                    location.href = "' . url('/index/logout') . '";
                }'
            ]);
        }

        if ($this->userInfo->isEmpty() && !in_array($this->request->action(), ['logout', 'login', 'index'])) {
            showAlert(lang('Account is locked'), [
                'end' => 'function () {
                    location.href = "' . url('/index/logout') . '";
                }'
            ]);
            exit();
        }

        $this->view->assign('user', $this->userInfo);
    }

    public function delSession()
    {
        Session::delete('company');
    }
}
