<?php


namespace app\common\controller;

use think\facade\Session;
use app\common\model\User as UserModel;
use app\company\model\Company as CompanyModel;

class ApiController extends \app\BaseController
{
    protected $noNeedLogin = ['login'];

    protected $userInfo = null;

    protected $userType = 'user';

    protected $UserModel = null;

    protected $CompanyModel = null;

    protected $model = null;

    protected $token = null;

    protected $returnData = [
        'code' => 0,
        'msg' => '未知错误',
        'data' => [],
//        'sub_code' => 'unknow error',
//        'sub_msg' => '系统繁忙',
    ];

    protected function initialize()
    {
        parent::initialize(); // TODO: Change the autogenerated stub

        $this->UserModel = UserModel::class;
        $this->CompanyModel = CompanyModel::class;
        $this->userType = $this->request->param('userType', '');
        $this->token = $this->request->param('token');
        $action = $this->request->action();

        if (!in_array($action, $this->noNeedLogin)) {
            if (!$this->token) {
                response(['code' => 5003, 'msg' => '权限不足：未登录'], 5003, [], 'json')->send();
                exit;
            }

            if (!$this->userType) {
                $this->returnData['msg'] = '未提供正确的参数：userType';
                response($this->returnData, 200, [], 'json')->send();
                exit;
            }

            if ($this->userType === 'user') {
                $this->userInfo = UserModel::where('token', $this->token)->find();
            } else if ($this->userType === 'company') {
                $this->userInfo = CompanyModel::where('token', $this->token)->find();
            }

            if (!$this->userInfo) {
                response(['code' => 5003, 'msg' => '用户不存在或未登录'], 5003, ['abc' => 'token'], 'json')->send();
                exit;
            }

            if ($this->userInfo->token_expire_time < time()) {
                response(['code' => 5003, 'msg' => '登录过期，请重新登录'], 5003, [], 'json')->send();
                exit;
            }
        }
    }

    protected function getUserInfo()
    {
        return $this->userInfo;
    }

    protected function isLogin()
    {
        return Session::has('api_' . $this->userType);
    }
}
